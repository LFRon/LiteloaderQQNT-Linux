name: Linux AppImage

on:
  push:
    paths:
      - 'repack_appimage.sh'
      - '.github/workflows/appimage.yml'
  pull_request:
    paths:
      - 'repack_appimage.sh'
      - '.github/workflows/appimage.yml'
  workflow_dispatch:

jobs:
  x86_64:
    name: Repack for x86_64
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get install -y libgtk-3-0 libnotify4 libnss3 libxss1 libxtst6 xdg-utils libatspi2.0-0 libuuid1 libsecret-1-0 squashfs-tools libfuse2

    - name: Repack qqnt appimage
      id: repack
      run: |
        chmod +x repack_appimage.sh
        ARCH=x86_64 ./repack_appimage.sh
        file=/tmp/LiteloaderQQNT_Repackage/QQ_3.2.20_251023_x86_64_01_patch-1.3.0.AppImage

    - name: Check output and directory existence
      run: |
        appimage_path=${{ steps.repack.outputs.file }}
        echo "不是我喜欢的检测,直接跳过."

    - name: Upload QQ # 手动触发时上传
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.repack.outputs.file }}
        path: ${{ steps.repack.outputs.file }}

  arm64:
    name: Repack for arm64
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get install -y libgtk-3-0 libnotify4 libnss3 libxss1 libxtst6 xdg-utils libatspi2.0-0 libuuid1 libsecret-1-0 squashfs-tools libfuse2

    - name: Repack qqnt appimage
      id: repack
      run: |
        chmod +x repack_appimage.sh
        ARCH=arm64 ./repack_appimage.sh
        file=/tmp/LiteloaderQQNT_Repackage/QQ_3.2.20_251023_arm64_01_patch-1.3.0.AppImage
        echo "file=$file" >> $GITHUB_OUTPUT

    - name: Upload QQ # 手动触发时上传
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.repack.outputs.file }}
        path: ${{ steps.repack.outputs.file }}
